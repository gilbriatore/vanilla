<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanilla</title>
</head>
<body>
    <h1>App Vanilla</h1>
    <button id="btnArquivo">Carregar arquivo.json</button>
    <button id="btnAPI">Requisitar API produtos json</button>
    <button id="btnImagem">Carregar imagem</button>
    <button id="btnProdutos">Cadastrar produtos</button>
    <main>
        <!--Conteúdo inserido pelo código javascript-->
    </main>
    <script>
        var main = document.getElementsByTagName('main')[0];

        function configurarForm(produto){

          if (produto != null) {
            var form = document.getElementById('frmProdutos');  
            form.nome.value = produto.nome;
            form.desc.value = produto.desc;
          }

          var btnSalvar = document.getElementById('btnSalvar');
            btnSalvar.onclick = ()=> {
                 
                var form = document.getElementById('frmProdutos'); 
                var nome = form.nome.value;
                var desc = form.desc.value;

                var json = {
                    "nome": nome,
                    "desc": desc
                };

                if (produto == null) {
                  fetch("/produtos", {
                  headers: {
                      'Accept': 'application/json',
                      'Content-Type': 'application/json'
                  },
                  method: "POST",
                      body: JSON.stringify(json)
                  }).then(()=> {
                    main.innerHTML = '';
                    carregarJsonTabela('http://localhost:3000/produtos');
                  });
                } else {
                  fetch("/produtos/" + produto.id, {
                  headers: {
                      'Accept': 'application/json',
                      'Content-Type': 'application/json'
                  },
                  method: "PUT",
                      body: JSON.stringify(json)
                  }).then(()=> {
                    main.innerHTML = '';
                    carregarJsonTabela('http://localhost:3000/produtos');
                  });
                }
                
            } 
        }
        
        function carregarHTML(url, elemento, produto) {
                fetch(url).then((resposta) => {
                    return resposta.text();
                }).then((html) => {
                   elemento.innerHTML = html;
                }).then(()=>{
                    configurarForm(produto);
                });
            }

        function carregarJson(url){
            fetch(url)
            .then((resposta)=> {
                return resposta.json();
            })
            .then((json)=>{
                criarLista(json);
            })
        }

        function carregarJsonTabela(url){
            fetch(url)
            .then((resposta)=> {
                return resposta.json();
            })
            .then((json)=>{
                gerarTabela(json);
            })
        }




        function gerarTabela(produtos) {

            // get the reference for the main
            var main = document.getElementsByTagName('main')[0];

            var btnIncluir = document.createElement("button");
            btnIncluir.innerText = "Incluir";
            btnIncluir.onclick = ()=> {
                carregarHTML('form.html', main);
            }

            main.appendChild(btnIncluir);


            // creates a <table> element and a <tbody> element
            var tbl = document.createElement("table");
            var tblBody = document.createElement("tbody");


            function excluirProduto(id){
              fetch("http://localhost:3000/produtos/" + id, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: "DELETE"
                }).then(()=> {
                  main.innerHTML = '';
                  carregarJsonTabela('http://localhost:3000/produtos');
                });
            }

            var qtdeLinhas = produtos.length;
            var qtdeColunas = 4;

            // Gerar as linhas da tabela
            for (var i = 0; i < qtdeLinhas; i++) {
                var produto = produtos[i];


                var row = document.createElement("tr");

                // Gerar as colunas da tabela

                var cell = document.createElement("td");
                var cellText = document.createTextNode(produto.id);
                cell.appendChild(cellText);
                row.appendChild(cell);


                var cell = document.createElement("td");
                var cellText = document.createTextNode(produto.nome);
                cell.appendChild(cellText);
                row.appendChild(cell);


                var cell = document.createElement("td");
                var cellText = document.createTextNode(produto.desc);
                cell.appendChild(cellText);
                row.appendChild(cell);

                var linkExcluir = document.createElement("a");
                var lblExcluir = document.createTextNode("Excluir");
                linkExcluir.appendChild(lblExcluir);
                linkExcluir.href = "#";
                linkExcluir.title = "Excluir";
                linkExcluir.onclick = ()=> {
                  if (confirm('Tem certeza que deseja excluir o produto?')) {
                    excluirProduto(produto.id);
                  } 
                }

                var linkEditar = document.createElement("a");
                var lblEditar = document.createTextNode("Editar");
                linkEditar.appendChild(lblEditar);
                linkEditar.href = "#";
                linkEditar.title = "Editar";
                linkEditar.onclick = ()=> {
                  carregarHTML('form.html', main, produto);
                }

                var cell = document.createElement("td");
                cell.appendChild(linkExcluir);
                cell.appendChild(linkEditar);
                row.appendChild(cell);




                // for (var j = 0; j < qtdeColunas; j++) {
                                
                // var cell = document.createElement("td");
                // var cellText = document.createTextNode("cell in row "+i+", column "+j);
                // cell.appendChild(cellText);
                // row.appendChild(cell);
                // }

                // add the row to the end of the table body
                tblBody.appendChild(row);
            }

            // put the <tbody> in the <table>
            tbl.appendChild(tblBody);
            // appends <table> into <main>
            main.appendChild(tbl);
            // sets the border attribute of tbl to 2;
            tbl.setAttribute("border", "2");
        }



        
        function criarLista(produtos){
            const lista = document.createElement('ul');
            for (const produto of produtos) {
                const item = document.createElement('li');
                item.innerText = produto.nome;   
                lista.appendChild(item);                                     
            }
            main.appendChild(lista);
        }
        
        var btnArquivo = document.getElementById('btnArquivo');
        var btnAPI = document.getElementById('btnAPI');
        var btnImagem = document.getElementById('btnImagem');
        var btnProdutos = document.getElementById('btnProdutos');
        
        

        function carregarImagem(url){
            fetch(url)
            .then((resposta)=> {
                return resposta.blob();
            })
            .then((imgCarregada)=>{
                var imgElemento = document.createElement('img');
                imgElemento.src = URL.createObjectURL(imgCarregada);
                main.appendChild(imgElemento);
            })
        }

        btnImagem.onclick = ()=>{
          main.innerHTML = '';  
          carregarImagem('imgs/carne1.jpg');
        }

        btnArquivo.onclick = ()=>{
          main.innerHTML = '';           
          carregarJson('data/arquivo.json');
        }

        btnAPI.onclick = ()=>{           
          main.innerHTML = '';
          carregarJson('http://localhost:3000/produtos');
        }

        btnProdutos.onclick = ()=> {
          main.innerHTML = '';
          carregarJsonTabela('http://localhost:3000/produtos');
        }
    </script>
</body>
</html>